apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: verdaccio-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  rules:
  - http:
      paths:
      - path: /npm
        pathType: Prefix
        backend:
          service:
            name: verdaccio
            port:
              number: 80
  - host: npm.localhost
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: verdaccio
            port:
              number: 80
---
kind: Service
apiVersion: v1
metadata:
  name: verdaccio
spec:
  type: ClusterIP
  selector:
    app: verdaccio
  ports:
    - port: 80
      targetPort: 4873
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: verdaccio-config
  labels:
    app: verdaccio
data:
  config.yaml: |
    listen:
      - http://0.0.0.0:4873
    auth:
      htpasswd:
        file: /verdaccio/data/htpasswd
    storage: ./data
    store:
      memory:
        limit: 1000
    uplinks:
      npmjs:
        url: https://registry.npmjs.org/
        cache: false
    packages:
      "@*/*":
        access: $all
        publish: $all
        proxy: npmjs
      "**":
        proxy: npmjs
    logs:
      type: stdout
      format: pretty
      level: debug
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: verdaccio
spec:
  replicas: 1
  selector:
    matchLabels:
      app: verdaccio
  template:
    metadata:
      labels:
        app: verdaccio
    spec:
      containers:
        - name: verdaccio
          image: verdaccio/verdaccio
          imagePullPolicy: Always
          ports:
            - containerPort: 4873
          env:
            # k8s' auto-defined ENV var name gets detected and used by the app
            # code, unless we re-override it - cf. https://github.com/verdaccio/docker-examples/issues/21#issuecomment-671186754
            - name: VERDACCIO_PORT
              value: '4873'
          volumeMounts:
            - name: config
              mountPath: /verdaccio/conf
            - name: data
              mountPath: /verdaccio/data
      volumes:
        - name: config
          configMap:
            name: verdaccio-config
        - name: data
          emptyDir: {}
